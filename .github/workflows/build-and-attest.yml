name: Build and Attest Container

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  id-token: write  # Required for Sigstore signing

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image with Witness
        uses: testifysec/witness-run-action@v0.3.0
        with:
          step: docker-build
          command: docker buildx build --push --platform linux/amd64 --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest --metadata-file docker-metadata.json --provenance=true --sbom=true --cache-from type=gha --cache-to type=gha,mode=max .
          attestations: docker slsa git github secretscan
          attestor-slsa-export: true
          enable-sigstore: true
          enable-archivista: true

      - name: Display attestation metadata
        id: attestation
        run: |
          echo "## Attestation Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse docker metadata
          if [ -f docker-metadata.json ]; then
            echo "### ðŸ“¦ Docker Build Output" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '{"image": .["image.name"], "digest": .["containerimage.digest"], "size": .["containerimage.descriptor"].size}' docker-metadata.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key metadata for easy reference
            IMAGE_DIGEST=$(jq -r '.["containerimage.digest"]' docker-metadata.json)
            echo "**Image Digest:** \`$IMAGE_DIGEST\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # SLSA metadata preview
          if [ -f slsa-predicate.json ]; then
            echo "### ðŸ” SLSA Provenance Preview" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '{buildType: .buildDefinition.buildType, builder: .runDetails.builder.id}' slsa-predicate.json >> $GITHUB_STEP_SUMMARY || echo "SLSA predicate will be generated"
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate attestation summary and Archivista queries
        run: |
          echo "## Build Attestation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Container image built and pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Provenance captured with Witness" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Signed with Sigstore" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Attestation uploaded to Archivista" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Attestations Captured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following attestations were generated:" >> $GITHUB_STEP_SUMMARY
          echo "- **Git**: Repository state and commit information" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub**: GitHub Actions context (workflow, runner, OIDC token)" >> $GITHUB_STEP_SUMMARY
          echo "- **Command Run**: Exact build command executed" >> $GITHUB_STEP_SUMMARY
          echo "- **Materials**: Input files used in the build" >> $GITHUB_STEP_SUMMARY
          echo "- **Products**: Output files created (docker-metadata.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: Container image digest and build materials" >> $GITHUB_STEP_SUMMARY
          echo "- **SLSA**: Complete SLSA v1.0 provenance predicate" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Scan**: Verification that no secrets were exposed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add Archivista GraphQL query examples
          echo "## Query Attestations in Archivista" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use these GraphQL queries at https://archivista.testifysec.io/query" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Find all container images built from this repository" >> $GITHUB_STEP_SUMMARY
          echo '```graphql' >> $GITHUB_STEP_SUMMARY
          echo 'query {' >> $GITHUB_STEP_SUMMARY
          echo '  subjects(where: {' >> $GITHUB_STEP_SUMMARY
          echo '    nameContains: "ghcr.io/testifysec/witness-demo"' >> $GITHUB_STEP_SUMMARY
          echo '  }) {' >> $GITHUB_STEP_SUMMARY
          echo '    edges {' >> $GITHUB_STEP_SUMMARY
          echo '      node {' >> $GITHUB_STEP_SUMMARY
          echo '        name' >> $GITHUB_STEP_SUMMARY
          echo '        subjectDigests {' >> $GITHUB_STEP_SUMMARY
          echo '          algorithm' >> $GITHUB_STEP_SUMMARY
          echo '          value' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '      }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ—ï¸ Find builds by GitHub actor (who triggered the build)" >> $GITHUB_STEP_SUMMARY
          echo '```graphql' >> $GITHUB_STEP_SUMMARY
          echo 'query {' >> $GITHUB_STEP_SUMMARY
          echo '  subjects(where: {' >> $GITHUB_STEP_SUMMARY
          echo '    nameContains: "github.com/testifysec/witness-demo/actions"' >> $GITHUB_STEP_SUMMARY
          echo '  }) {' >> $GITHUB_STEP_SUMMARY
          echo '    edges {' >> $GITHUB_STEP_SUMMARY
          echo '      node {' >> $GITHUB_STEP_SUMMARY
          echo '        name' >> $GITHUB_STEP_SUMMARY
          echo '        statement {' >> $GITHUB_STEP_SUMMARY
          echo '          predicate' >> $GITHUB_STEP_SUMMARY
          echo '          attestationCollections {' >> $GITHUB_STEP_SUMMARY
          echo '            attestations {' >> $GITHUB_STEP_SUMMARY
          echo '              body' >> $GITHUB_STEP_SUMMARY
          echo '            }' >> $GITHUB_STEP_SUMMARY
          echo '          }' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '      }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Get full attestation bundle by GitOID" >> $GITHUB_STEP_SUMMARY
          echo '```graphql' >> $GITHUB_STEP_SUMMARY
          echo 'query AttestationByGitOID($gitoid: String!) {' >> $GITHUB_STEP_SUMMARY
          echo '  dsses(where: {' >> $GITHUB_STEP_SUMMARY
          echo '    gitoidSha256: $gitoid' >> $GITHUB_STEP_SUMMARY
          echo '  }) {' >> $GITHUB_STEP_SUMMARY
          echo '    edges {' >> $GITHUB_STEP_SUMMARY
          echo '      node {' >> $GITHUB_STEP_SUMMARY
          echo '        gitoidSha256' >> $GITHUB_STEP_SUMMARY
          echo '        payloadType' >> $GITHUB_STEP_SUMMARY
          echo '        signatures {' >> $GITHUB_STEP_SUMMARY
          echo '          keyID' >> $GITHUB_STEP_SUMMARY
          echo '          signature' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '        payloadDigests {' >> $GITHUB_STEP_SUMMARY
          echo '          algorithm' >> $GITHUB_STEP_SUMMARY
          echo '          value' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '        statement {' >> $GITHUB_STEP_SUMMARY
          echo '          predicate' >> $GITHUB_STEP_SUMMARY
          echo '          subjects {' >> $GITHUB_STEP_SUMMARY
          echo '            edges {' >> $GITHUB_STEP_SUMMARY
          echo '              node {' >> $GITHUB_STEP_SUMMARY
          echo '                name' >> $GITHUB_STEP_SUMMARY
          echo '              }' >> $GITHUB_STEP_SUMMARY
          echo '            }' >> $GITHUB_STEP_SUMMARY
          echo '          }' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '      }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Find attestations for specific Docker image digest" >> $GITHUB_STEP_SUMMARY
          echo '```graphql' >> $GITHUB_STEP_SUMMARY
          echo 'query ImageByDigest($digest: String!) {' >> $GITHUB_STEP_SUMMARY
          echo '  subjects(where: {' >> $GITHUB_STEP_SUMMARY
          echo '    nameContains: "ghcr.io"' >> $GITHUB_STEP_SUMMARY
          echo '    subjectDigests: {' >> $GITHUB_STEP_SUMMARY
          echo '      value: $digest' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }) {' >> $GITHUB_STEP_SUMMARY
          echo '    edges {' >> $GITHUB_STEP_SUMMARY
          echo '      node {' >> $GITHUB_STEP_SUMMARY
          echo '        name' >> $GITHUB_STEP_SUMMARY
          echo '        statement {' >> $GITHUB_STEP_SUMMARY
          echo '          dsse {' >> $GITHUB_STEP_SUMMARY
          echo '            edges {' >> $GITHUB_STEP_SUMMARY
          echo '              node {' >> $GITHUB_STEP_SUMMARY
          echo '                gitoidSha256' >> $GITHUB_STEP_SUMMARY
          echo '              }' >> $GITHUB_STEP_SUMMARY
          echo '            }' >> $GITHUB_STEP_SUMMARY
          echo '          }' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '      }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Find all SLSA provenance attestations" >> $GITHUB_STEP_SUMMARY
          echo '```graphql' >> $GITHUB_STEP_SUMMARY
          echo 'query {' >> $GITHUB_STEP_SUMMARY
          echo '  dsses(where: {' >> $GITHUB_STEP_SUMMARY
          echo '    payloadType: "application/vnd.in-toto+json"' >> $GITHUB_STEP_SUMMARY
          echo '  }, first: 10) {' >> $GITHUB_STEP_SUMMARY
          echo '    edges {' >> $GITHUB_STEP_SUMMARY
          echo '      node {' >> $GITHUB_STEP_SUMMARY
          echo '        gitoidSha256' >> $GITHUB_STEP_SUMMARY
          echo '        statement {' >> $GITHUB_STEP_SUMMARY
          echo '          predicate' >> $GITHUB_STEP_SUMMARY
          echo '          subjects {' >> $GITHUB_STEP_SUMMARY
          echo '            edges {' >> $GITHUB_STEP_SUMMARY
          echo '              node {' >> $GITHUB_STEP_SUMMARY
          echo '                name' >> $GITHUB_STEP_SUMMARY
          echo '              }' >> $GITHUB_STEP_SUMMARY
          echo '            }' >> $GITHUB_STEP_SUMMARY
          echo '          }' >> $GITHUB_STEP_SUMMARY
          echo '        }' >> $GITHUB_STEP_SUMMARY
          echo '      }' >> $GITHUB_STEP_SUMMARY
          echo '    }' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Download and analyze attestation locally" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# Download attestation by GitOID' >> $GITHUB_STEP_SUMMARY
          echo 'curl -s https://archivista.testifysec.io/download/<GITOID> -o attestation.json' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# Decode and explore the attestation' >> $GITHUB_STEP_SUMMARY
          echo 'jq -r ".payload" attestation.json | base64 -d | jq .' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# Extract specific attestation types' >> $GITHUB_STEP_SUMMARY
          echo 'jq -r ".payload" attestation.json | base64 -d | \' >> $GITHUB_STEP_SUMMARY
          echo '  jq ".predicate.attestations[] | select(.type == \"https://witness.dev/attestations/docker/v0.1\")"' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# Check GitHub actor from attestation' >> $GITHUB_STEP_SUMMARY
          echo 'jq -r ".payload" attestation.json | base64 -d | \' >> $GITHUB_STEP_SUMMARY
          echo '  jq ".predicate.attestations[] | select(.type == \"https://witness.dev/attestations/github/v0.1\") | .attestation.jwt.claims.actor"' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY